---
import type {
  FiresideChatStoryblok,
  FiresideChatsListingsStoryblok,
} from "@storyblok/types";
import { getStories } from "@/services/storyblok/get-stories";
import { parseAsset } from "@/services/storyblok/utils/parse-asset";
import { parseLink } from "@/services/storyblok/utils/parse-link";
import type { Prettify } from "@/types";
import FiresideChatListing from "./item.astro";
import { storyblokEditable, type SbBlokData } from "@storyblok/astro";
import Pagination from "@/components/ui/pagination.astro";
import Heading from "@/components/ui/heading.astro";
import BodyText from "@/components/ui/body-text.astro";
import Label from "@/components/ui/label.astro";
import IconLink from "@/components/ui/icon-link.astro";

type Props = {
  blok: Prettify<FiresideChatsListingsStoryblok>;
};

const PER_PAGE = 1;
const pageNumber = Astro.url.searchParams.get("page");
const currentPage = pageNumber ? Number.parseInt(pageNumber) : 1;

const { stories: firesideChats, total } =
  await getStories<FiresideChatStoryblok>({
    contentType: "firesideChat",
    version: import.meta.env.CONTENT_VERSION,
    per_page: PER_PAGE,
    page: currentPage,
  });

// Calculate total pages
const totalPages = Math.ceil(total / PER_PAGE);

const {
  blok: { title, subtitle, subscribeLinks, subscribeLinksCaption },
} = Astro.props;
---

<div
  class="bg-dark-down text-text-000 relative overflow-hidden rounded-br-2xl rounded-bl-2xl py-16 pb-18 sm:pt-24"
  {...storyblokEditable(Astro.props.blok as SbBlokData)}
>
  <div>
    <div class="py-32">
      <div class="flex items-center justify-center">
        <div
          class="h-24 w-full bg-[url('/svg/soundwave.svg')] bg-contain bg-right bg-repeat-x"
        >
        </div>
        <div class="w-full flex-1 px-12">
          <Heading level="xxl" class="whitespace-nowrap">{title}</Heading>
        </div>
        <div
          class="h-24 w-full bg-[url('/svg/soundwave-2.svg')] bg-contain bg-left bg-repeat-x"
        >
        </div>
      </div>

      <!-- Subscribe links and subtitle -->
      <div class="flex flex-col items-center">
        <BodyText
          size="l"
          class="mx-auto mt-6 mb-8 max-w-2xl text-center text-balance"
        >
          {subtitle}
        </BodyText>
        {
          subscribeLinks && subscribeLinks.length > 0 && (
            <div class="flex w-full flex-col items-center">
              <ul class="border-accent-electric mb-6 flex items-center gap-4 rounded-2xl border p-3">
                {subscribeLinks.map((link) => (
                  <li>
                    <IconLink iconClassName="h-12 w-12" blok={link} />
                  </li>
                ))}
              </ul>
              <Label
                size="s"
                weight="semibold"
                class="text-text-000 mx-auto w-full text-center"
              >
                {subscribeLinksCaption}
              </Label>
            </div>
          )
        }
      </div>
    </div>

    <div class="container mx-auto">
      {
        firesideChats.length > 0 ? (
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 sm:gap-8 lg:grid-cols-3">
            {firesideChats.map((chat) => (
              <FiresideChatListing story={chat} />
            ))}
          </div>
        ) : (
          <BodyText size="m" class="text-text-200 text-center">
            No fireside chats available at the moment.
          </BodyText>
        )
      }

      {
        totalPages > 1 && (
          <div class="mt-12 sm:mt-16">
            <Pagination currentPage={currentPage} totalPages={totalPages} />
          </div>
        )
      }
    </div>
  </div>
</div>
